function stCountry(a){if(a>=10000000){return 20}return Math.floor(a/100000+0.1)}var SNGCodes={"26":"Эст","25":"Лат","24":"Литва","21":"Белоруссия","22":"Украина","23":"Молд","57":"Айзер","58":"Арм","28":"Груз","27":"Казах","59":"Кирг","29":"Узб","66":"Тадж","67":"Турк","42":"Абх"};function isForeignCode(a){var b=stCountry(a);return !(b=="20"||(b in SNGCodes))}var Sug2=new function(){var j={},c={};this.requestURL="";this.minChars=2;this.aflags=3;this.listLimit=12;var g=[];var f=lang("$ID");if(f.charAt(0)=="$"){f="ru"}this.getStations=function(){return c};function a(m){var l=m.indexOf(",");if(l<0){return m}return m.substring(0,l)}function e(l){$("<div/>").text(l).appendTo("#Trace")}function b(){return"localStorage" in window}var d={};function i(p,o){if(o===undefined){var m=null;if(b()){try{m=localStorage.getItem(p)}catch(n){}}if(!m){m=d[p]}if(m){m=JSON.parse(m)}return m}else{var l=0;if(b()){try{localStorage.setItem(p,JSON.stringify(o));l=1}catch(n){}}if(!l){d[p]=o}}}this.bind=function(M){var P=$("<div/>").addClass("dropList").hide().appendTo("body").click(function(Q){Q.stopPropagation();return false});if(typeof M.defaultRecent=="string"){var G,m,C=M.defaultRecent.split(","),E=[];for(G in C){m=C[G].split(":");if(m.length==2){E.push({name:m[0],code:+m[1]})}}M.defaultRecent=E}var L=$(M.input);if(L.length!=1){return alert("Sug2.bind() require 1 input parameter")}var D=$(M.wait),K=M.onStation,o="";L.attr("autocomplete","off");L.keyup(n).change(F);L.focus(N).blur(v);L.click(function(Q){Q.stopPropagation()});var I=[],H=$(M.recentElem),J=M.recentID;function u(T){var S="StRecent_"+J;S+="_"+f;if(T=="L"&&b()){I=i(S)||I;var R,Q=true;for(R in I){if(!((typeof I[R]=="object")&&("name" in I[R])&&("code" in I[R]))){Q=false;break}}if(!Q){I=[]}}else{i(S,I)}}function B(R){var Q=I.length-1;while(Q>=0&&I[Q].code!=R){Q--}if(Q<0){return null}return I[Q]}function z(){var R=+$(this).attr("href").substring(1),Q=B(R);if(Q){L.val(Q.name);t(Q.code)}return false}if(H.length&&J){var I=0;if(b()){u("L")}if(!I.length){I=M.defaultRecent||I}u("S");function A(){var Q="";H.empty();for(var R in I){var S=I[R];if(!S.name){continue}H.append(Q);Q=", ";$("<a/>").attr("href","#"+S.code).text(capitalize(S.name)).appendTo(H).click(z)}}A();g.push(function(){var T=L.data("code"),R=c[T],U={code:T},S=I.length-1;if(!T){return}U.name=R?R.n:L.val().toUpperCase();var Q=U.name.split(",");U.name=$.trim(Q[0]);while(S>=0&&I[S].code!=T){S--}if(S>=0){I.splice(S,1)}I.unshift(U);I.length=Math.min(I.length,7);u("S");A()})}function v(){if(!P.is(":visible")){return}P.fadeOut(200);$(window).unbind("click",p)}function p(){v();return false}function t(Q){if(K){K(Q)}L.data("code",Q)}function s(Q){var R=(D.data("Cnt")||0)+Q;D.css("visibility",R>0?"visible":"hidden").data("Cnt",R);$("#Keys").text(JSON.stringify(j))}function N(){var Q=L.val();if(Q.length<Sug2.minChars){v()}else{x(1)}}var r={"1":function(Q){return Q.L},"2":function(Q){return Q.S},"3":function(Q){return Q.S+Q.L}};function x(af){var U,Q,ad=k(L.val()),W=[];if(ad!=o){o=ad;P.empty();var ac=Sug2.aflags,ab=0,S=0;if(!/[\(\)\\\/\^\$\*\+\?\.]/.test(ad)){S=RegExp("(-|\\s|^|\\()"+ad)}for(U in c){Q=c[U];if((ac==1&&!Q.L)||(ac==2&&!Q.S)){continue}var aa=Q.ns,T,R;for(T in aa){if(T.indexOf(ad)==0||(S&&S.test(T))){W.push(R={st:Q,k:T,n:aa[T]});if(aa[T]==ad){ab=R}}}}if(W.length==1){ab=W[0]}t(ab?ab.st.c:"");if(W.length==0){return v()}var Z=r[Sug2.aflags];W.sort(function(aj,ah){var ai=Z(aj.st),ag=Z(ah.st);if(ai>ag){return -1}if(ai<ag){return 1}if(aj.n<ah.n){return -1}if(aj.n>ah.n){return 1}return 0});var ae=Math.min(W.length,Sug2.listLimit);if(W.length>ae){var V=[];for(U=ae;U<W.length;U++){var Y=$.trim(W[U].n.split(",")[0]).toUpperCase();if(Y==ad){V.push(W[U])}}W.length=ae;for(U in V){W.push(V[U])}}for(U in W){R=W[U];$("<div/>").addClass("station").data("code",R.st.c).text(R.n).appendTo(P).click(w)}}if(P.find(".station").length==0){return}if(!L.is(":focus")){if(!af){return}}if(!P.is(":visible")){P.fadeIn(200);$(window).click(p)}var X=L.offset();X.top+=L.outerHeight();X.width=L.outerWidth();P.css(X)}function w(){L.val($(this).text());t($(this).data("code"));v()}var O="dropListSel";function l(Q){if(!P.is(":visible")){N()}if(!P.is(":visible")){return}var S=P.find("."+O);if(S.length==0){P.find(".station:first").addClass(O);return}var R=P.find(".station"),T=R.index(S);T+=Q;if(T<0){T+=R.length}else{if(T==R.length){T=0}}S.removeClass(O);R.eq(T).addClass(O)}function y(R){var Q=P.find("."+O);if(Q.length==0){return}if(R){R.stopPropagation();R.preventDefault()}w.call(Q)}function n(R){var Q=R.which;switch(Q){case 38:l(-1);break;case 40:l(1);break;case 27:v();break;case 13:if(P.is(":visible")){y(R)}break;default:q()}}function q(){var Q=k(L.val());if(Q.length<Sug2.minChars){v();return t("")}var R=Q.substring(0,Sug2.minChars),S=j[R];if(S===2){x()}else{if(S!==1){function T(U,V){$.ajax({url:"/suggester",dataType:"json",data:{stationNamePart:R,lang:f,lat:lang("$Cyrillic")=="No"?1:0,compactMode:"y"},success:U,error:V,complete:function(){s(-1)}})}j[R]=1;s(1);T(function(W){j[R]=2;for(var V in W){var U=W[V],Y=c[U.c];U.k=k(a(U.n));if(U.c in c){c[U.c].ns[U.k]=U.n}else{U.ns={};U.ns[U.k]=U.n;c[U.c]=U}}var X=k(L.val()).substring(0,Sug2.minChars);if(X==R){x()}},function(V,U,W){j[R]=0})}}}function F(){q();var Q=L.data("code");if(Q){L.val(c[Q].n)}t(Q)}};var h={F:"А","<":"Б",",":"Б",D:"В",U:"Г",L:"Д",T:"Е","`":"Е","~":"Е","Ё":"Е",":":"Ж",";":"Ж",P:"З",B:"И",Q:"Й",R:"К",K:"Л",V:"М",Y:"Н",J:"О",G:"П",H:"Р",C:"С",N:"Т",E:"У",A:"Ф","{":"Х","[":"Х",W:"Ц",X:"Ч",I:"Ш",O:"Щ","}":"Ъ","]":"Ъ",S:"Ы",M:"Ь",'"':"Э","'":"Ю",Z:"Я"};function k(o){var l=0,n=$.trim(o.toLocaleUpperCase()),p="",m;if(f!="ru"){return n}for(;l<n.length;l++){m=n.charAt(l);if(m in h){p+=h[m]}else{p+=m}}return p}this.updateRecents=function(){for(var l in g){g[l]()}}}();